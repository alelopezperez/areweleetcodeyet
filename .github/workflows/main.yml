name: Build & deploy

on:
  push:
    branches:
      - main
    paths:
      - website-astro/**      
  pull_request:
    branches:
      - main      
    paths:
      - website-astro/**

jobs:
  Build:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./website-astro    
    steps:
    - uses: actions/checkout@v3
    - name: Use Node.js
      uses: actions/setup-node@v3
      with:
        node-version: 18
        check-latest: true
    - name: Install dependencies
      run: yarn --frozen-lockfile      
    - name: Building Astro Website
      run: yarn build && ls
    - name: Deploying    
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-region: us-east-1
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    - name: Upload
      env:
        AWS3: ${{ secrets.AWS_S3_CDN }}
      run: aws s3 sync --delete ./dist s3://$AWS3
    - name: Invalidate1
      env: # Or as an environment variable
        Dist1: ${{ secrets.AWS_DIST_1 }}
      run: aws cloudfront create-invalidation --distribution-id $Dist1 --paths "/**/*"      
    - name: Invalidate2
      env: # Or as an environment variable
        Dist2: ${{ secrets.AWS_DIST_2 }}
      run: aws cloudfront create-invalidation --distribution-id $Dist2 --paths "/**/*"
        
    
     

